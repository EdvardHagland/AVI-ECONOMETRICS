"0","# Load necessary packages"
"0","library(lme4)  # For mixed effects models to calculate ICC"
"0",""
"0","# Calculate ICC for Wave 2 model"
"0","calc_icc <- function(data, formula_str) {"
"0","  # Fit a mixed model with random intercept for region"
"0","  formula <- as.formula(paste(formula_str, ""+ (1|Region)""))"
"0","  re_model <- lmer(formula, data=data)"
"0","  "
"0","  # Extract variance components"
"0","  vc <- VarCorr(re_model)"
"0","  region_var <- attr(vc$Region, ""stddev"")^2"
"0","  residual_var <- attr(vc, ""sc"")^2"
"0","  "
"0","  # Calculate ICC"
"0","  icc <- region_var / (region_var + residual_var)"
"0","  "
"0","  # Return ICC and model"
"0","  return(list(icc = icc, model = re_model))"
"0","}"
"0",""
"0","# Calculate ICC for both waves"
"0","w2_icc_result <- calc_icc("
"0","  subset(mig_long, wave!=3 & nonmissing2),"
"0","  ""mg.asp ~ treat.dum*post.dum"""
"0",")"
"0",""
"0","w3_icc_result <- calc_icc("
"0","  subset(mig_long, wave!=2 & nonmissing3),"
"0","  ""mg.asp ~ treat.dum*post.dum"""
"0",")"
"0",""
"0","# Extract ICCs"
"0","w2_icc <- w2_icc_result$icc"
"0","w3_icc <- w3_icc_result$icc"
"0",""
"0","# Create a table of ICCs"
"0","icc_table <- data.frame("
"0","  Wave = c(""Wave 2"", ""Wave 3""),"
"0","  ICC = c(w2_icc, w3_icc)"
"0",")"
"0",""
"0","# Display ICC table"
"0","icc_table %>%"
"0","  kbl("
"0","    caption = ""Intraclass Correlation Coefficients (ICC) by Region"","
"0","    col.names = c(""Analysis"", ""ICC""),"
"0","    digits = c(0, 3),"
"0","    align = c(""l"", ""r""),"
"0","    booktabs = TRUE"
"0","  ) %>%"
"0","  kable_styling("
"0","    latex_options = c(""striped"", ""HOLD_position""), "
"0","    bootstrap_options = ""striped"","
"0","    position = ""center"","
"0","    font_size = 9,"
"0","    full_width = FALSE"
"0","  ) %>%"
"0","  footnote("
"0","    number = c("
"0","      ""ICC represents the proportion of total variance in migration aspirations attributable to regional clusters."","
"0","      paste0(""Rule of thumb: ICC > 0.05 suggests clustering is necessary for correct inference."")"
"0","    ),"
"0","    footnote_as_chunk = TRUE"
"0","  )"
