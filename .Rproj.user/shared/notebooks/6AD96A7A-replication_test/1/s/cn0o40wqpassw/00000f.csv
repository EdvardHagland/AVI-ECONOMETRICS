"0","# --- INTENT: Replicate Table 1 from the paper, showing weighted percentages of business outcomes by treatment group in Wave 3. ---"
"0","# --- EFFECT: This chunk processes the `mig_wide` data, calculates weighted means and significance tests for specific business variables, formats the results, and generates a LaTeX table using `kableExtra`. ---"
"0",""
"0","# Prepare the data"
"0","mig_business <- mig_wide %>%"
"0","  # Create factor for treatment"
"0","  mutate(treat.dum_fac = factor(treat.dum, levels = c(0, 1), labels = c(""Control"", ""Treatment"")))"
"0",""
"0","# Business outcome variables for Wave 3"
"0","business_vars <- c(""bus.location"", ""bus.open"", ""bus.purchases"", ""bus.hire"", ""bus.profit"", ""bus.close"")"
"0",""
"0","# Create a filtered dataset without NA weights"
"0","filtered_data <- mig_business %>%"
"0","  filter(!is.na(wt3)) %>%"
"0","  # Ensure business variables are numeric"
"0","  mutate(across(all_of(business_vars), as.numeric))"
"0",""
"0","# Calculate the weighted means by treatment group"
"0","results <- lapply(business_vars, function(var) {"
"0","  # For Control group"
"0","  control_mean <- weighted.mean(filtered_data[[var]][filtered_data$treat.dum == 0], "
"0","                              w = filtered_data$wt3[filtered_data$treat.dum == 0], "
"0","                              na.rm = TRUE)"
"0","  "
"0","  # For Treatment group"
"0","  treat_mean <- weighted.mean(filtered_data[[var]][filtered_data$treat.dum == 1], "
"0","                            w = filtered_data$wt3[filtered_data$treat.dum == 1], "
"0","                            na.rm = TRUE)"
"0","  "
"0","  # Calculate F-test"
"0","  model <- lm(as.formula(paste(var, ""~ treat.dum"")), "
"0","              data = filtered_data, "
"0","              weights = wt3)"
"0","  f_value <- summary(model)$fstatistic[1]"
"0","  p_value <- pf(f_value, "
"0","                summary(model)$fstatistic[2], "
"0","                summary(model)$fstatistic[3], "
"0","                lower.tail = FALSE)"
"0","  "
"0","  # Determine significance markers"
"0","  sig_marker <- case_when("
"0","    p_value < 0.001 ~ ""***"","
"0","    p_value < 0.01 ~ ""**"","
"0","    p_value < 0.05 ~ ""*"","
"0","    p_value < 0.1 ~ ""†"","
"0","    TRUE ~ """""
"0","  )"
"0","  "
"0","  # Format the F-test with significance marker"
"0","  f_test <- paste0(""F="", round(f_value, 2), sig_marker)"
"0","  "
"0","  # Return results for this variable"
"0","  data.frame("
"0","    Variable = var,"
"0","    Control = control_mean,"
"0","    Treatment = treat_mean,"
"0","    F_test = f_test"
"0","  )"
"0","})"
"0",""
"0","# Combine results into a single data frame"
"0","results_df <- bind_rows(results)"
"0",""
"0","# Calculate the difference in percentage points"
"0","results_df <- results_df %>% "
"0","  mutate("
"0","    Difference_pp = (Treatment - Control) * 100"
"0","  )"
"0",""
"0","# Define nice variable labels"
"0","var_labels <- c("
"0","  ""bus.location"" = ""Selected location"","
"0","  ""bus.open"" = ""Opened business"", "
"0","  ""bus.purchases"" = ""Made purchases"","
"0","  ""bus.hire"" = ""Hired employees"","
"0","  ""bus.profit"" = ""Made profit"","
"0","  ""bus.close"" = ""Closed business"""
"0",")"
"0",""
"0","# Replace variable names with labels"
"0","results_df$Variable <- var_labels[results_df$Variable]"
"0",""
"0","# Format the calculated means as percentages and the difference to two decimal places"
"0","results_df <- results_df %>%"
"0","  mutate("
"0","    Control = scales::percent(Control, accuracy = 0.01),"
"0","    Treatment = scales::percent(Treatment, accuracy = 0.01),"
"0","    Difference_pp = sprintf(""%.2f"", Difference_pp) # Format difference to 2 decimal places"
"0","  )"
"0",""
"0","# Generate the table using basic knitr::kable approach"
"0","knitr::kable("
"0","  results_df %>% dplyr::select(Variable, Control, Treatment, Difference_pp, F_test),"
"0","  caption = ""Table 1: Key Business Outcomes by Treatment Group (Wave 3)"","
"0","  col.names = c(""Outcome"", ""Control (%)"", ""Treatment (%)"", ""Difference (p.p.)"", ""Test""),"
"0","  align = c(""l"", ""r"", ""r"", ""r"", ""r""),"
"0","  format = ""latex"","
"0","  booktabs = TRUE,"
"0","  escape = FALSE"
"0",") %>%"
"0","  add_header_above(c("" "" = 1, ""Group"" = 2, "" "" = 2)) %>%"
"0","  add_footnote("
"0","    c(""Significance levels: *** p<0.001, ** p<0.01, * p<0.05, † p<0.1."","
"0","      ""Percentages calculated using Wave 3 inverse probability weights (wt3).""),"
"0","    notation = ""none"""
"0","  )"
