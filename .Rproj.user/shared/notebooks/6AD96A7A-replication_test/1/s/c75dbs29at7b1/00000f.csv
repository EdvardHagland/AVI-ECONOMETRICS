"0","# --- INTENT: Replicate Figure 3 using iterative mediate() calls ---"
"0",""
"0","# Load necessary libraries (Moved to setup chunk)"
"0","# library(mediation)"
"0","# library(Hmisc)"
"0","# library(tidyverse)"
"0","# library(RColorBrewer)"
"0",""
"0","# Define base mediator names (without wave suffix)"
"0","mediators_base <- Cs(self.suff, efficacy, placeat)"
"0",""
"0","# Define confounding variables (covariates)"
"0","confounders <- Cs(age, educ, male, bs.exp.now, bs.exp.past, Score)"
"0",""
"0","# Treatment variable"
"0","treatment <- ""treat.dum"""
"0",""
"0","# Create consistent plot aesthetics"
"0","color_palette <- brewer.pal(3, ""Set1"")[c(2,1)] # Red for Wave 2, Blue for Wave 3"
"0","pd <- position_dodge(width = 0.3) "
"0",""
"0","# Initialize an empty list to store results from each mediate() call"
"0","results_list <- list()"
"0",""
"0","# --- Loop through each mediator and each wave --- "
"0","for (med_base in mediators_base) {"
"0","  for (wave_num in c(2, 3)) {"
"0","    "
"0","    # Define wave-specific variables"
"0","    wave_label <- paste0(""Wave "", wave_num)"
"0","    outcome_var <- paste0(""mg.asp_w"", wave_num)"
"0","    mediator_var <- paste0(med_base, ""_w"", wave_num)"
"0","    weight_var <- paste0(""wt"", wave_num)"
"0","    wave_time_label <- ifelse(wave_num == 2, ""Short-term (Wave 2)"", ""Long-term (Wave 3)"")"
"0",""
"0","    # message(paste(""\nProcessing:"", med_base, ""-"", wave_label)) # Commented out"
"0",""
"0","    # Check if required base data exists"
"0","    if (!exists(""mig_wide"")) {"
"0","      stop(""Error: mig_wide not found. Please ensure setup chunk has run."")"
"0","    }"
"0","    "
"0","    # Prepare data for this specific mediator/wave"
"0","    # 1. Filter for non-missing weights for the current wave"
"0","    # 2. Convert to data.frame (as it solved issues previously)"
"0","    data_wave_df <- as.data.frame(subset(mig_wide, !is.na(mig_wide[[weight_var]])))"
"0","    "
"0","    # 3. Define all columns needed for this specific analysis"
"0","    required_cols <- c(outcome_var, mediator_var, treatment, confounders, weight_var)"
"0","    "
"0","    # 4. Check if all required columns actually exist in the data"
"0","    missing_cols <- setdiff(required_cols, names(data_wave_df))"
"0","    if (length(missing_cols) > 0) {"
"0","      # warning(paste(""Skipping"", med_base, wave_label, "": Missing columns:"", paste(missing_cols, collapse="", ""))) # Commented out"
"0","      next # Skip to next iteration"
"0","    }"
"0","    "
"0","    # 5. Filter for complete cases *for these specific variables*"
"0","    complete_cases_data <- data_wave_df[complete.cases(data_wave_df[, required_cols]), ]"
"0","    n_complete <- nrow(complete_cases_data)"
"0","    # message(paste(""  Number of complete observations:"", n_complete)) # Commented out"
"0",""
"0","    # Skip if insufficient data"
"0","    if (n_complete < 30) {"
"0","      # warning(paste(""Skipping"", med_base, wave_label, "": Insufficient complete observations ("", n_complete, "")"")) # Commented out"
"0","      next "
"0","    }"
"0","    "
"0","    # --- Fit Mediator Model --- "
"0","    med_formula_str <- paste(mediator_var, ""~"", treatment, ""+"", paste(confounders, collapse="" + ""))"
"0","    med_model <- tryCatch({"
"0","      lm(as.formula(med_formula_str), "
"0","         data = complete_cases_data, "
"0","         weights = complete_cases_data[[weight_var]])"
"0","    }, error = function(e) {"
"0","      # warning(paste(""Skipping"", med_base, wave_label, "": Error fitting mediator model:"", e$message)) # Commented out"
"0","      return(NULL)"
"0","    })"
"0","    "
"0","    if (is.null(med_model)) next # Skip if mediator model failed"
"0",""
"0","    # --- Fit Outcome Model --- "
"0","    out_formula_str <- paste(outcome_var, ""~"", treatment, ""*"", mediator_var, ""+"", paste(confounders, collapse="" + ""))"
"0","    out_model <- tryCatch({"
"0","      lm(as.formula(out_formula_str), "
"0","         data = complete_cases_data, "
"0","         weights = complete_cases_data[[weight_var]])"
"0","    }, error = function(e) {"
"0","      # warning(paste(""Skipping"", med_base, wave_label, "": Error fitting outcome model:"", e$message)) # Commented out"
"0","      return(NULL)"
"0","    })"
"0","    "
"0","    if (is.null(out_model)) next # Skip if outcome model failed"
"0",""
"0","    # --- Run Mediation --- "
"0","    mediation_result <- tryCatch({"
"0","      mediate(med_model, out_model, "
"0","              treat = treatment, "
"0","              mediator = mediator_var, "
"0","              sims = 1000) # Using 1000 simulations like original"
"0","    }, error = function(e) {"
"0","      # warning(paste(""Skipping"", med_base, wave_label, "": Error running mediate():"", e$message)) # Commented out"
"0","      return(NULL)"
"0","    })"
"0",""
"0","    # --- Extract Results if successful --- "
"0","    if (!is.null(mediation_result)) {"
"0","      summary_med <- summary(mediation_result)"
"0","      "
"0","      # --- (Diagnostic print removed) ---"
"0","      "
"0","      # --- Robust Extraction of ACME (average) estimate and CI ---"
"0","      estimate_val <- NULL"
"0","      conf_low_val <- NULL"
"0","      conf_high_val <- NULL"
"0","      "
"0","      # Based on str() output, extract directly from $d.avg and $d.avg.ci"
"0","      # Check if the components $d.avg and $d.avg.ci exist and have the expected structure"
"0","      if (!is.null(summary_med$d.avg) && length(summary_med$d.avg) == 1 && is.numeric(summary_med$d.avg) &&"
"0","          !is.null(summary_med$d.avg.ci) && length(summary_med$d.avg.ci) == 2 && is.numeric(summary_med$d.avg.ci)) {"
"0","          "
"0","          estimate_val <- summary_med$d.avg"
"0","          conf_low_val <- summary_med$d.avg.ci[1] # First element is lower bound"
"0","          conf_high_val <- summary_med$d.avg.ci[2] # Second element is upper bound"
"0","          "
"0","          # Store results only if all values were successfully extracted (redundant check now, but safe)"
"0","          if (!is.null(estimate_val) && !is.null(conf_low_val) && !is.null(conf_high_val)) {"
"0","              results_list[[length(results_list) + 1]] <- data.frame("
"0","                mediator = med_base, # Store base name"
"0","                estimate = estimate_val, "
"0","                conf_low = conf_low_val,"
"0","                conf_high = conf_high_val,"
"0","                wave = wave_time_label, # Store descriptive time label"
"0","                stringsAsFactors = FALSE"
"0","              )"
"0","              # message(""  Successfully processed and stored results."") # Commented out"
"0","           } else {"
"0","              # warning(paste(""Failed to extract one or more necessary ACME components for"", med_base, wave_label)) # Commented out"
"0","           }"
"0",""
"0","      } else {"
"0","          # warning(paste(""Summary object missing expected components ($d.avg, $d.avg.ci) or they have unexpected structure for"", med_base, wave_label)) # Commented out"
"0","      }"
"0","       # --- End Robust Extraction ---"
"0",""
"0","    }"
"0","    "
"0","  } # End wave loop"
"0","} # End mediator loop"
"0",""
"0","# --- Combine and Plot Results --- "
"0",""
"0","if (length(results_list) > 0) {"
"0","  all_med_results <- bind_rows(results_list)"
"0","  "
"0","  # Create mapping from variable names to nicer labels"
"0","  mediator_labels <- c("
"0","    ""self.suff"" = ""Self-\\nsufficiency"","
"0","    ""efficacy"" = ""Personal\\nefficacy"","
"0","    ""placeat"" = ""Financial\\nsuccess\\nat home"""
"0","  )"
"0","  "
"0","  # Order for y-axis (from top to bottom)"
"0","  ordered_labels <- c("
"0","    ""Financial\\nsuccess\\nat home"","
"0","    ""Personal\\nefficacy"","
"0","    ""Self-\\nsufficiency"""
"0","  )"
"0","  "
"0","  # Process results for plotting"
"0","  plot_data <- all_med_results %>%"
"0","    mutate("
"0","      # Use the base mediator name stored earlier"
"0","      mediator_label = factor(mediator_labels[mediator], levels = ordered_labels) "
"0","    ) %>% "
"0","    filter(!is.na(mediator_label)) # Ensure only valid mapped labels"
"0","  "
"0","  if (nrow(plot_data) > 0) {"
"0","      # Create the plot"
"0","      fig3_plot <- ggplot(plot_data, "
"0","                         aes(x = estimate, y = mediator_label, "
"0","                             color = wave, shape = wave)) +"
"0","        geom_vline(xintercept = 0, linetype = ""dashed"", color = ""grey60"", linewidth = 0.8) +"
"0","        geom_errorbarh(aes(xmin = conf_low, xmax = conf_high), "
"0","                      height = 0, position = pd, linewidth = 0.8) +"
"0","        geom_point(position = pd, size = 3.5, stroke = 1.2) +"
"0","        scale_color_manual(values = color_palette, name = ""Time Point:"") +"
"0","        scale_shape_manual(values = c(""Short-term (Wave 2)"" = 16, ""Long-term (Wave 3)"" = 1), "
"0","                          name = ""Time Point:"") +"
"0","        labs("
"0","          title = ""Figure 3: Average Causal Mediation Effects (ACME)"","
"0","          subtitle = ""Iterative 'mediate' estimates (1000 simulations) with 95% CIs"","
"0","          x = ""Average Causal Mediation Effect (ACME)"","
"0","          y = NULL"
"0","        ) +"
"0","        theme_minimal(base_size = 11) +"
"0","        theme("
"0","          legend.position = ""top"","
"0","          legend.title = element_text(face = ""bold""),"
"0","          legend.key = element_rect(fill = ""white"", colour = ""white""),"
"0","          legend.background = element_rect(fill = ""white"", colour = NA),"
"0","          axis.text.y = element_text(hjust = 1, vjust = 0.5, size = 10),"
"0","          axis.title.x = element_text(size = 10, face = ""bold""),"
"0","          plot.title = element_text(face = ""bold"", size = 14, hjust = 0.5),"
"0","          plot.subtitle = element_text(size = 10, hjust = 0.5, margin = margin(b = 15)),"
"0","          panel.grid.major.y = element_blank(),"
"0","          panel.grid.minor.x = element_blank(),"
"0","          panel.grid.major.x = element_line(color = ""grey90"", linetype = ""dotted"")"
"0","        ) +"
"0","        coord_cartesian(xlim = c(-0.2, 0.2))"
"0","      "
"0","      # Display the plot"
"0","      print(fig3_plot)"
"0","  } else {"
"0","      # message(""Plotting skipped: No valid data after processing results."") # Commented out"
"0","  }"
"0",""
"0","} else {"
"0","  # message(""Plotting skipped: No successful mediation results were obtained from any mediator/wave combination."") # Commented out"
"0","}"
"0",""
