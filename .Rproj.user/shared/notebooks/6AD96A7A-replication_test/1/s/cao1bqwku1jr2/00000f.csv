"0","# --- INTENT: Re-estimate key models with clustered standard errors ---"
"0","# --- EFFECT: Uses sandwich and lmtest packages to compute cluster-robust SEs ---"
"0","message(""Running Robustness Check 5: Clustered Standard Errors..."")"
"0",""
"0","# Load necessary packages"
"0","library(sandwich)  # For robust standard errors"
"0","library(lmtest)    # For coeftest to display models with adjusted SEs"
"0",""
"0","# Re-run the key Wave 2 and Wave 3 models (already estimated earlier)"
"0","# We don't need to re-estimate the models, just adjust their standard errors"
"0",""
"0","# Function to extract and format clustered SE results"
"0","clustered_results <- function(model, cluster_var, model_name) {"
"0","  # Regular model summary"
"0","  reg_summary <- summary(model)"
"0","  reg_coef <- coef(reg_summary)[""treat.dum:post.dum"", ""Estimate""]"
"0","  reg_se <- coef(reg_summary)[""treat.dum:post.dum"", ""Std. Error""]"
"0","  reg_p <- coef(reg_summary)[""treat.dum:post.dum"", ""Pr(>|t|)""]"
"0","  "
"0","  # Clustered model summary"
"0","  clust_summary <- coeftest(model, vcov = vcovCL(model, cluster = cluster_var))"
"0","  clust_coef <- clust_summary[""treat.dum:post.dum"", ""Estimate""]"
"0","  clust_se <- clust_summary[""treat.dum:post.dum"", ""Std. Error""]"
"0","  clust_p <- clust_summary[""treat.dum:post.dum"", ""Pr(>|t|)""]"
"0","  "
"0","  # Result row"
"0","  data.frame("
"0","    Model = model_name,"
"0","    Regular_Coef = reg_coef,"
"0","    Regular_SE = reg_se,"
"0","    Regular_P = reg_p,"
"0","    Clustered_SE = clust_se,"
"0","    Clustered_P = clust_p,"
"0","    SE_Ratio = clust_se / reg_se"
"0","  )"
"0","}"
"0",""
"0","# Extract cluster variable and results for Wave 2 models"
"0","w2_data <- subset(mig_long, wave!=3 & nonmissing2)"
"0","w2_cluster <- w2_data$Region # Cluster variable"
"0","w2_results <- clustered_results(asp.did.w2, w2_cluster, ""W2 DiD Weighted"")"
"0","w2_unw_results <- clustered_results(asp.did.w2_unw, w2_cluster, ""W2 DiD Unweighted"")"
"0",""
"0","# Extract cluster variable and results for Wave 3 models"
"0","w3_data <- subset(mig_long, wave!=2 & nonmissing3)"
"0","w3_cluster <- w3_data$Region # Cluster variable"
"0","w3_results <- clustered_results(asp.did.w3, w3_cluster, ""W3 DiD Weighted"")"
"0","w3_unw_results <- clustered_results(asp.did.w3_unw, w3_cluster, ""W3 DiD Unweighted"")"
"0",""
"0","# Combine results into a table"
"0","se_comparison <- rbind(w2_results, w2_unw_results, w3_results, w3_unw_results)"
"0",""
"0","# Display formatted table using kable"
"0","se_comparison %>%"
"0","  kbl("
"0","    caption = ""Regular vs. Clustered Standard Errors (DiD Main Effect)"","
"0","    col.names = c(""Model"", ""Coefficient"", ""Regular SE"", ""Regular p-value"", "
"0","                  ""Clustered SE"", ""Clustered p-value"", ""SE Ratio""),"
"0","    digits = c(0, 3, 3, 3, 3, 3, 2),"
"0","    align = c(""l"", ""r"", ""r"", ""r"", ""r"", ""r"", ""r""),"
"0","    booktabs = TRUE"
"0","  ) %>%"
"0","  kable_styling(latex_options = c(""striped"", ""HOLD_position""), "
"0","                bootstrap_options = ""striped"") %>%"
"0","  footnote("
"0","    general = c(""SE Ratio = Clustered SE / Regular SE. Ratio > 1 indicates standard errors are larger when clustering.""),"
"0","    footnote_as_chunk = TRUE,"
"0","    escape = FALSE"
"0","  )"
