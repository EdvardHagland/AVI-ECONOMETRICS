"0","# --- INTENT: Estimate DiD models with interaction terms for HTE using mig_long. ---"
"0","# --- EFFECT: Runs lm() models including triple interactions (treat*post*moderator). ---"
"0","message(""Running Robustness Check 4: Heterogeneity of Treatment Effects (Interactions)..."")"
"0",""
"0","# Ensure mig_long exists"
"0","if (!exists(""mig_long"")) {"
"0","  stop(""Error in robust-hte-models: mig_long data frame not found."")"
"0","}"
"0",""
"0","# We use the Wave 2 dataset where effects were significant"
"0","data_w2_hte <- subset(mig_long, wave != 3 & nonmissing2) # Use mig_long"
"0",""
"0","# Base formula part"
"0","base_hte_formula <- ""mg.asp ~ treat.dum * post.dum * MODERATOR + factor(Region)"""
"0",""
"0","# Function to create and run HTE model"
"0","run_hte_model <- function(moderator_var, data) {"
"0","  if (!moderator_var %in% names(data)) {"
"0","    message(""Moderator variable '"", moderator_var, ""' not found. Skipping HTE for this variable."")"
"0","    return(NULL)"
"0","  }"
"0","  # Check for sufficient variation in moderator"
"0","  if (length(unique(na.omit(data[[moderator_var]]))) < 2) {"
"0","      message(""Moderator variable '"", moderator_var, ""' has insufficient variation. Skipping HTE."")"
"0","      return(NULL)"
"0","  }"
"0",""
"0","  formula_str <- gsub(""MODERATOR"", moderator_var, base_hte_formula)"
"0","  model <- tryCatch({"
"0","      lm(as.formula(formula_str), data = data, weights = wt2)"
"0","    }, error = function(e) {"
"0","      message(""Error fitting HTE model for "", moderator_var, "": "", e$message); return(NULL)"
"0","  })"
"0","  # if (!is.null(model)) print(summary(model)) # DEBUG PRINT REMOVED"
"0","  return(model)"
"0","}"
"0",""
"0","# Estimate models for each moderator (using variables confirmed in mig_long)"
"0","hte_male <- run_hte_model(""male"", data_w2_hte)"
"0","hte_educ <- run_hte_model(""educ"", data_w2_hte) # Treat educ as numeric/ordinal"
"0","hte_bs_exp <- run_hte_model(""bs.exp.now"", data_w2_hte)"
"0",""
"0","message(""HTE interaction models estimated (if data allowed)."")"
